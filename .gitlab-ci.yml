include:
  - component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/build-changelog@$CI_COMMIT_SHA
    inputs:
      job: build-changelog
      stage: build-changelog
    rules:
      - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == main'
      - changes:
          - changelog/**/*.yml

image: node:20

stages:
  - build
  - deploy

build:
  stage: build
  before_script:
    - corepack enable
    - pnpm install --frozen-lockfile
  script:
    - pnpm lint
    - pnpm build

publish-npm:
  stage: deploy
  variables:
    REGISTRY: "@jelmore1674:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"
    TOKEN: "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}"
  before_script:
    - corepack enable
    - pnpm install --frozen-lockfile
    - pnpm build
  script:
    - echo $REGISTRY > .npmrc
    - echo $TOKEN >> .npmrc
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == main'
