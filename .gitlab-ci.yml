include:
  - component: $CI_SERVER_FQDN/jelmore1674/ci-templates/build-changelog@main
    inputs:
      job: changelog
      stage: changelog
    rules:
      - changes:
          - changelog/**/*.yml
      - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'

image: node:20

stages:
  - build
  - changelog
  - deploy

build:
  stage: build
  before_script:
    - corepack enable
    - pnpm install --frozen-lockfile
  script:
    - pnpm lint
    - pnpm build
  rules:
    - changes:
        - src/*

publish-npm:
  stage: deploy
  variables:
    REGISTRY: "@jelmore1674:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"
    TOKEN: "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}"
  before_script:
    - corepack enable
    - pnpm install --frozen-lockfile
    - pnpm build
  script:
    - echo $REGISTRY > .npmrc
    - echo $TOKEN >> .npmrc
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG
