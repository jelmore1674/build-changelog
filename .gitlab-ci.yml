include:
  - component: $CI_SERVER_FQDN/jelmore1674/ci-templates/build-changelog@main
    inputs:
      job: changelog
      stage: changelog
    rules:
      - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
        changes:
          - changelog/**/*.yml

image: node:20

stages:
  - build
  - test
  - deploy
  - changelog

build:
  stage: build
  before_script:
    - corepack enable
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm lint
    - pnpm build
  rules:
    - changes:
        - src/*
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
      - dist

test:
  stage: test
  needs: [build]
  before_script:
    - corepack enable
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm test
  rules:
    - changes:
        - src/*
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules

publish-npm:
  stage: deploy
  variables:
    REGISTRY: "@jelmore1674:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"
    TOKEN: "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}"
  before_script:
    - corepack enable
    - pnpm config set store-dir .pnpm-store
  script:
    - echo $REGISTRY > .npmrc
    - echo $TOKEN >> .npmrc
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG && '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - dist
